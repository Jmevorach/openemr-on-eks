---
# Fluent Bit Configuration for OpenEMR Log Aggregation
# This ConfigMap contains the Fluent Bit configuration for collecting and forwarding logs to CloudWatch
# Fluent Bit runs as a sidecar container alongside the OpenEMR application
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-sidecar-config
  namespace: openemr
  labels:
    app: fluent-bit-sidecar
data:
  fluent-bit.conf: |
    # Fluent Bit Service Configuration
    # Core settings for log processing and HTTP monitoring
    [SERVICE]
        Flush         1
        Log_Level     info
        Daemon        off
        HTTP_Server   On
        HTTP_Listen   0.0.0.0
        HTTP_Port     2020
        HTTP_Allow    *
        Health_Check  On
        HC_Errors_Count 50              
        HC_Retry_Failure_Count 10              
        HC_Period     60
        storage.type  filesystem              
        storage.path  /tmp/fluent-bit-buffer
        storage.backlog.mem_limit 50M
        storage.pause_on_chunks_overlimit On
        storage.max_chunks_up 256              

    # Test log input to verify functionality
    # Generates test logs to verify Fluent Bit is working correctly
    [INPUT]
        Name             dummy
        Tag              test.logs
        Dummy            {"message": "Fluent Bit sidecar is working!", "timestamp": "2025-08-26", "level": "INFO"}
        Rate             1

    # Collect Apache access logs
    # Monitors HTTP access logs for web traffic analysis
    [INPUT]
        Name              tail
        Path              /var/log/apache2/access.log
        Tag               apache.access
        Refresh_Interval  5
        Buffer_Max_Size   5MB         
        Skip_Empty_Lines  On

    # Collect Apache error logs
    # Monitors Apache error logs for troubleshooting
    [INPUT]
        Name              tail
        Path              /var/log/apache2/error.log
        Tag               apache.error
        Refresh_Interval  5
        Buffer_Max_Size   5MB         
        Skip_Empty_Lines  On

    # Collect OpenEMR application logs
    # Monitors OpenEMR-specific application logs
    [INPUT]
        Name              tail
        Path              /var/log/openemr/*.log
        Tag               openemr.application
        Refresh_Interval  5
        Buffer_Max_Size   5MB         
        Skip_Empty_Lines  On
        Skip_Long_Lines   On          
        Ignore_Older      24h          
        Path_Key          filename     
        exit_on_eof       false        

    # Collect OpenEMR system logs
    # Monitors OpenEMR system logs from the sites directory
    [INPUT]
        Name              tail
        Path              /var/www/localhost/htdocs/openemr/sites/default/documents/logs_and_misc/system_logs/*.log
        Tag               openemr.system
        Refresh_Interval  5
        Buffer_Max_Size   5MB         
        Skip_Empty_Lines  On
        Skip_Long_Lines   On          
        Ignore_Older      24h          
        Path_Key          filename     
        exit_on_eof       false        

    # Collect OpenEMR audit logs
    # Monitors OpenEMR audit logs for compliance and security
    [INPUT]
        Name              tail
        Path              /var/www/localhost/htdocs/openemr/sites/default/documents/logs_and_misc/audit_logs/*.log
        Tag               openemr.audit
        Refresh_Interval  5
        Buffer_Max_Size   5MB         
        Skip_Empty_Lines  On
        Skip_Long_Lines   On          
        Ignore_Older      24h          
        Path_Key          filename     
        exit_on_eof       false        

    # Collect PHP error logs
    # Monitors PHP error logs for application debugging
    [INPUT]
        Name              tail
        Path              /var/log/php_errors.log
        Tag               openemr.php_error
        Refresh_Interval  5
        Buffer_Max_Size   5MB         
        Skip_Empty_Lines  On

    # Forward protocol for external log sources
    # Allows external systems to send logs to Fluent Bit
    [INPUT]
        Name              forward
        Listen            0.0.0.0
        Port              24224
        Tag               forward.logs

    # Fluent Bit Metrics
    # Collects system metrics for monitoring Fluent Bit performance
    # Note: Requires privileged access to /sys and /proc for system metrics
    [INPUT]
        Name              node_exporter_metrics
        Tag               fluent-bit.metrics
        Scrape_Interval   30
        path.procfs       /host/proc
        path.sysfs        /host/sys

    # Record modifier filter
    # Adds metadata to all log records for better tracking and filtering
    [FILTER]
        Name                record_modifier
        Match               *
        Record              cluster_name ${CLUSTER_NAME}
        Record              region ${AWS_REGION}
        Record              openemr_version 7.0.3.4
        Record              pod_name ${HOSTNAME}

    # Test logs output (for verification)
    # Sends test logs to CloudWatch for verification
    [OUTPUT]
        Name                cloudwatch_logs
        Match               test.logs
        region              ${AWS_REGION}
        log_group_name      /aws/eks/${CLUSTER_NAME}/openemr/test
        log_stream_prefix   test-
        auto_create_group   true
        retry_limit         3

    # Apache logs output
    # Sends Apache access and error logs to CloudWatch
    [OUTPUT]
        Name                cloudwatch_logs
        Match               apache.*
        region              ${AWS_REGION}
        log_group_name      /aws/eks/${CLUSTER_NAME}/openemr/apache
        log_stream_prefix   apache-
        auto_create_group   true
        retry_limit         3

    # Forward logs output
    # Sends forwarded logs to CloudWatch
    [OUTPUT]
        Name                cloudwatch_logs
        Match               forward.logs
        region              ${AWS_REGION}
        log_group_name      /aws/eks/${CLUSTER_NAME}/openemr/forward
        log_stream_prefix   forward-
        auto_create_group   true
        retry_limit         3

    # OpenEMR Application Logs
    # Sends OpenEMR application logs to CloudWatch
    [OUTPUT]
        Name                cloudwatch_logs
        Match               openemr.application
        region              ${AWS_REGION}
        log_group_name      /aws/eks/${CLUSTER_NAME}/openemr/application
        log_stream_prefix   application-
        auto_create_group   true
        retry_limit         3

    # OpenEMR System Logs
    # Sends OpenEMR system logs to CloudWatch
    [OUTPUT]
        Name                cloudwatch_logs
        Match               openemr.system
        region              ${AWS_REGION}
        log_group_name      /aws/eks/${CLUSTER_NAME}/openemr/system
        log_stream_prefix   system-
        auto_create_group   true
        retry_limit         3

    # OpenEMR Audit Logs
    # Sends OpenEMR audit logs to CloudWatch
    [OUTPUT]
        Name                cloudwatch_logs
        Match               openemr.audit
        region              ${AWS_REGION}
        log_group_name      /aws/eks/${CLUSTER_NAME}/openemr/audit
        log_stream_prefix   audit-
        auto_create_group   true
        retry_limit         3

    # PHP Error Logs
    # Sends PHP error logs to CloudWatch
    [OUTPUT]
        Name                cloudwatch_logs
        Match               openemr.php_error
        region              ${AWS_REGION}
        log_group_name      /aws/eks/${CLUSTER_NAME}/openemr/php_error
        log_stream_prefix   php-error-
        auto_create_group   true
        retry_limit         3

    # Fluent Bit Metrics
    # Sends Fluent Bit performance metrics to CloudWatch
    [OUTPUT]
        Name                cloudwatch_logs
        Match               fluent-bit.metrics
        region              ${AWS_REGION}
        log_group_name      /aws/eks/${CLUSTER_NAME}/fluent-bit/metrics
        log_stream_prefix   metrics-
        auto_create_group   true
        retry_limit         3

    # ===== LOKI OUTPUTS =====
    # Send all logs to Loki for unified log aggregation and visualization in Grafana
    # All Loki outputs are configured with graceful failure handling:
    # - Retry_Limit False: Retry indefinitely without crashing (buffered to disk)
    # - net.connect_timeout: 5 second connection timeout
    # - net.keepalive: off to avoid connection persistence issues
    
    # Test logs to Loki
    [OUTPUT]
        Name                loki
        Match               test.logs
        host                loki-gateway.monitoring.svc.cluster.local
        port                80
        uri                 /loki/api/v1/push
        labels              job=openemr, namespace=openemr, log_type=test, cluster=${CLUSTER_NAME}
        line_format         json
        auto_kubernetes_labels on
        Retry_Limit         False           
        net.connect_timeout 5               
        net.keepalive       off             

    # Apache logs to Loki
    [OUTPUT]
        Name                loki
        Match               apache.*
        host                loki-gateway.monitoring.svc.cluster.local
        port                80
        uri                 /loki/api/v1/push
        labels              job=openemr, namespace=openemr, log_type=apache, cluster=${CLUSTER_NAME}
        label_keys          $tag
        line_format         json
        auto_kubernetes_labels on
        Retry_Limit         False           
        net.connect_timeout 5               
        net.keepalive       off             

    # Forward logs to Loki
    [OUTPUT]
        Name                loki
        Match               forward.logs
        host                loki-gateway.monitoring.svc.cluster.local
        port                80
        uri                 /loki/api/v1/push
        labels              job=openemr, namespace=openemr, log_type=forward, cluster=${CLUSTER_NAME}
        line_format         json
        auto_kubernetes_labels on
        Retry_Limit         False           
        net.connect_timeout 5               
        net.keepalive       off             

    # OpenEMR Application logs to Loki
    [OUTPUT]
        Name                loki
        Match               openemr.application
        host                loki-gateway.monitoring.svc.cluster.local
        port                80
        uri                 /loki/api/v1/push
        labels              job=openemr, namespace=openemr, log_type=application, cluster=${CLUSTER_NAME}
        line_format         json
        auto_kubernetes_labels on
        Retry_Limit         False           
        net.connect_timeout 5               
        net.keepalive       off             

    # OpenEMR System logs to Loki
    [OUTPUT]
        Name                loki
        Match               openemr.system
        host                loki-gateway.monitoring.svc.cluster.local
        port                80
        uri                 /loki/api/v1/push
        labels              job=openemr, namespace=openemr, log_type=system, cluster=${CLUSTER_NAME}
        line_format         json
        auto_kubernetes_labels on
        Retry_Limit         False           
        net.connect_timeout 5               
        net.keepalive       off             

    # OpenEMR Audit logs to Loki
    [OUTPUT]
        Name                loki
        Match               openemr.audit
        host                loki-gateway.monitoring.svc.cluster.local
        port                80
        uri                 /loki/api/v1/push
        labels              job=openemr, namespace=openemr, log_type=audit, cluster=${CLUSTER_NAME}
        line_format         json
        auto_kubernetes_labels on
        Retry_Limit         False           
        net.connect_timeout 5               
        net.keepalive       off             

    # PHP Error logs to Loki
    [OUTPUT]
        Name                loki
        Match               openemr.php_error
        host                loki-gateway.monitoring.svc.cluster.local
        port                80
        uri                 /loki/api/v1/push
        labels              job=openemr, namespace=openemr, log_type=php_error, cluster=${CLUSTER_NAME}
        line_format         json
        auto_kubernetes_labels on
        Retry_Limit         False           
        net.connect_timeout 5               
        net.keepalive       off             

    # Fluent Bit Metrics to Loki
    [OUTPUT]
        Name                loki
        Match               fluent-bit.metrics
        host                loki-gateway.monitoring.svc.cluster.local
        port                80
        uri                 /loki/api/v1/push
        labels              job=fluent-bit, namespace=openemr, log_type=metrics, cluster=${CLUSTER_NAME}
        line_format         json
        auto_kubernetes_labels on
        Retry_Limit         False           
        net.connect_timeout 5               
        net.keepalive       off             