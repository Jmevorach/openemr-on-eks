---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-sidecar-config
  namespace: openemr
  labels:
    app: fluent-bit-sidecar
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush         1
        Log_Level     info
        Daemon        off
        HTTP_Server   On
        HTTP_Listen   0.0.0.0
        HTTP_Port     2020
        Health_Check  On
        HC_Errors_Count 5
        HC_Retry_Failure_Count 5
        HC_Period     60

    # Test log input to verify functionality
    [INPUT]
        Name              dummy
        Tag               test.logs
        Dummy            {"message": "Fluent Bit sidecar is working!", "timestamp": "2025-08-26", "level": "INFO"}
        Rate             1

    # Collect Apache access logs
    [INPUT]
        Name              tail
        Path              /var/log/apache2/access.log
        Tag               apache.access
        Refresh_Interval  5
        Mem_Buf_Limit     50MB
        Skip_Empty_Lines  On

    # Collect Apache error logs
    [INPUT]
        Name              tail
        Path              /var/log/apache2/error.log
        Tag               apache.error
        Refresh_Interval  5
        Mem_Buf_Limit     50MB
        Skip_Empty_Lines  On

    # Collect OpenEMR application logs
    [INPUT]
        Name              tail
        Path              /var/log/openemr/*.log
        Tag               openemr.application
        Refresh_Interval  5
        Mem_Buf_Limit     50MB
        Skip_Empty_Lines  On

    # Collect OpenEMR system logs
    [INPUT]
        Name              tail
        Path              /var/www/localhost/htdocs/openemr/sites/default/documents/logs_and_misc/system_logs/*.log
        Tag               openemr.system
        Refresh_Interval  5
        Mem_Buf_Limit     50MB
        Skip_Empty_Lines  On

    # Collect OpenEMR audit logs
    [INPUT]
        Name              tail
        Path              /var/www/localhost/htdocs/openemr/sites/default/documents/logs_and_misc/audit_logs/*.log
        Tag               openemr.audit
        Refresh_Interval  5
        Mem_Buf_Limit     50MB
        Skip_Empty_Lines  On

    # Collect PHP error logs
    [INPUT]
        Name              tail
        Path              /var/log/php_errors.log
        Tag               openemr.php_error
        Refresh_Interval  5
        Mem_Buf_Limit     50MB
        Skip_Empty_Lines  On

    # Forward protocol for external log sources
    [INPUT]
        Name              forward
        Listen            0.0.0.0
        Port              24224
        Tag               forward.logs

    # Fluent Bit Metrics
    [INPUT]
        Name              node_exporter_metrics
        Tag               fluent-bit.metrics
        Scrape_Interval   30

    [FILTER]
        Name                record_modifier
        Match               *
        Record              cluster_name ${CLUSTER_NAME}
        Record              region ${AWS_REGION}
        Record              openemr_version 7.0.3.4
        Record              pod_name ${HOSTNAME}

    # Test logs output
    [OUTPUT]
        Name                cloudwatch_logs
        Match               test.logs
        region              ${AWS_REGION}
        log_group_name      /aws/eks/${CLUSTER_NAME}/openemr/test
        log_stream_prefix   test-
        auto_create_group   true
        retry_limit         3

    # Apache logs output
    [OUTPUT]
        Name                cloudwatch_logs
        Match               apache.*
        region              ${AWS_REGION}
        log_group_name      /aws/eks/${CLUSTER_NAME}/openemr/apache
        log_stream_prefix   apache-
        auto_create_group   true
        retry_limit         3

    # Forward logs output
    [OUTPUT]
        Name                cloudwatch_logs
        Match               forward.logs
        region              ${AWS_REGION}
        log_group_name      /aws/eks/${CLUSTER_NAME}/openemr/forward
        log_stream_prefix   forward-
        auto_create_group   true
        retry_limit         3

    # OpenEMR Application Logs
    [OUTPUT]
        Name                cloudwatch_logs
        Match               openemr.application
        region              ${AWS_REGION}
        log_group_name      /aws/eks/${CLUSTER_NAME}/openemr/application
        log_stream_prefix   application-
        auto_create_group   true
        retry_limit         3

    # OpenEMR System Logs
    [OUTPUT]
        Name                cloudwatch_logs
        Match               openemr.system
        region              ${AWS_REGION}
        log_group_name      /aws/eks/${CLUSTER_NAME}/openemr/system
        log_stream_prefix   system-
        auto_create_group   true
        retry_limit         3

    # OpenEMR Audit Logs
    [OUTPUT]
        Name                cloudwatch_logs
        Match               openemr.audit
        region              ${AWS_REGION}
        log_group_name      /aws/eks/${CLUSTER_NAME}/openemr/audit
        log_stream_prefix   audit-
        auto_create_group   true
        retry_limit         3

    # PHP Error Logs
    [OUTPUT]
        Name                cloudwatch_logs
        Match               openemr.php_error
        region              ${AWS_REGION}
        log_group_name      /aws/eks/${CLUSTER_NAME}/openemr/php_error
        log_stream_prefix   php-error-
        auto_create_group   true
        retry_limit         3

    # Fluent Bit Metrics
    [OUTPUT]
        Name                cloudwatch_logs
        Match               fluent-bit.metrics
        region              ${AWS_REGION}
        log_group_name      /aws/eks/${CLUSTER_NAME}/fluent-bit/metrics
        log_stream_prefix   metrics-
        auto_create_group   true
        retry_limit         3